generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model agents {
  id         Int       @id @default(autoincrement())
  name       String?   @db.VarChar(100)
  email      String?   @db.VarChar(150)
  role       String?   @default("Sales Rep") @db.VarChar(50)
  active     Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamp(6)
}

model api_keys {
  id          String       @id
  businessId  String
  name        String
  keyHash     String       @unique
  status      ApiKeyStatus @default(ACTIVE)
  permissions Json?
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  businesses  businesses   @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@index([keyHash])
  @@index([status])
}

model business_chat_configs {
  id        String   @id
  tenantId  String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([isActive])
  @@index([tenantId])
}

model business_feature_overrides {
  id          String     @id
  business_id String
  feature_key String
  is_enabled  Boolean
  expires_at  DateTime?
  reason      String?
  created_by  String?
  created_at  DateTime   @default(now())
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([expires_at])
  @@index([feature_key])
}

model business_integrations {
  id            String     @id
  businessId    String     @unique
  stripeKey     String?
  twilioSid     String?
  twilioToken   String?
  emailProvider String     @default("gmail")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  deletedAt     DateTime?
  businesses    businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([deletedAt])
}

model business_policies {
  id            String     @id
  businessId    String     @unique
  deliveryZones Json
  timings       String?
  refundPolicy  String?
  taxRate       Decimal    @default(0) @db.Decimal(5, 2)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  deletedAt     DateTime?
  businesses    businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([deletedAt])
}

model businesses {
  id                         String                       @id
  name                       String
  slug                       String                       @unique
  email                      String                       @unique
  passwordHash               String
  status                     BusinessStatus               @default(TRIAL)
  phone                      String?
  website                    String?
  description                String?
  logo                       String?
  timezone                   String                       @default("UTC")
  currency                   String                       @default("USD")
  language                   String                       @default("en")
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  deletedAt                  DateTime?
  api_keys                   api_keys[]
  business_feature_overrides business_feature_overrides[]
  business_integrations      business_integrations?
  business_policies          business_policies?
  categories                 categories[]
  embeddings                 embeddings[]
  emergency_usage_pools      emergency_usage_pools[]
  knowledge_base             knowledge_base[]
  locations                  locations[]
  menu_items                 menu_items[]
  menus                      menus[]
  order_taking_agents        order_taking_agents[]
  orders                     orders[]
  overage_charges            overage_charges[]
  plan_changes               plan_changes[]
  plan_recommendations       plan_recommendations[]
  policies                   policies[]
  powerups                   powerups[]
  query_logs                 query_logs[]
  subscriptions              subscriptions[]
  usage_alerts               usage_alerts[]
  usage_events               usage_events[]
  usage_forecasts            usage_forecasts[]
  usage_metrics              usage_metrics[]
  usage_quotas               usage_quotas[]
  usage_rollups              usage_rollups[]
  users                      users[]

  @@index([deletedAt])
  @@index([email])
  @@index([slug])
  @@index([status])
}

model categories {
  id          String       @id
  businessId  String
  name        String
  description String?
  sortOrder   Int          @default(0)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  businesses  businesses   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  menu_items  menu_items[]

  @@index([businessId])
  @@index([deletedAt])
  @@index([sortOrder])
}

model chat_sessions {
  id             String    @id
  tenantId       String
  conversationId String
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?

  @@index([conversationId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([tenantId])
}

model conversations {
  id        String     @id
  tenantId  String
  createdAt DateTime   @default(now())
  messages  messages[]

  @@index([createdAt])
  @@index([tenantId])
}

model deals {
  id                  Int       @id @default(autoincrement())
  lead_id             Int?
  deal_title          String?   @db.VarChar(150)
  amount              Decimal?  @db.Decimal(10, 2)
  stage               String?   @default("Prospecting") @db.VarChar(50)
  expected_close_date DateTime? @db.Date
  closed_date         DateTime? @db.Date
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  leads               leads?    @relation(fields: [lead_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model embeddings {
  id          String        @id
  businessId  String
  contentType EmbeddingType
  contentId   String
  content     String
  embedding   Float[]
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  businesses  businesses    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, contentType, contentId])
  @@index([businessId, contentType])
  @@index([businessId])
  @@index([contentType])
  @@index([createdAt])
  @@index([deletedAt])
}

model emergency_usage_pools {
  id              String     @id
  business_id     String
  pool_type       String
  total_allocated Int
  used_amount     Int        @default(0)
  cost_per_unit   Int
  expires_at      DateTime
  justification   String?
  approved_by     String?
  created_at      DateTime   @default(now())
  updated_at      DateTime
  businesses      businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([expires_at])
}

model external_connections {
  id                   String              @id
  tenantId             String
  type                 DatabaseType
  name                 String
  host                 String
  port                 Int?
  database             String
  username             String
  password             String
  config               Json?
  status               ConnectionStatus    @default(ACTIVE)
  lastTested           DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime
  syncFrequencyMinutes Int?                @default(60)
  isAutoSyncEnabled    Boolean?            @default(true)
  lastSyncedAt         DateTime?
  nextSyncAt           DateTime?
  isSyncing            Boolean?            @default(false)
  followup_mappings    followup_mappings[]

  @@index([isAutoSyncEnabled])
  @@index([nextSyncAt])
  @@index([status])
  @@index([tenantId])
  @@index([type])
}

model feature_flags {
  id               String           @id
  plan_id          String
  feature_key      String
  feature_category String
  is_enabled       Boolean          @default(false)
  access_level     String           @default("restricted")
  usage_limit      Int?
  metadata         Json?
  created_at       DateTime         @default(now())
  plan_definitions plan_definitions @relation(fields: [plan_id], references: [id], onDelete: Cascade)

  @@unique([plan_id, feature_key])
}

model followup_deliveries {
  id             String         @id
  ruleId         String
  entityPk       String
  contact        String
  channel        String
  status         String         @default("pending")
  idempotencyKey String         @unique
  sentAt         DateTime?
  error          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  dedupeKey      String?        @unique
  followup_rules followup_rules @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([dedupeKey])
  @@index([ruleId])
  @@index([sentAt])
  @@index([status])
}

model followup_leads {
  id            String      @id
  name          String
  email         String
  replyStatus   ReplyStatus @default(NoReply)
  lastEmailSent DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime

  @@index([email])
  @@index([lastEmailSent])
  @@index([replyStatus])
}

model followup_mappings {
  id                   String                @id
  resource             String
  fields               Json
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  connectionId         String?
  validatedAt          DateTime?
  userId               String?
  external_connections external_connections? @relation(fields: [connectionId], references: [id])
  users                users?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  followup_rules       followup_rules[]
  mapping_validations  mapping_validations[]

  @@unique([connectionId, resource])
  @@index([connectionId])
  @@index([resource])
  @@index([userId])
}

model followup_rules {
  id                  String                @id
  mappingId           String
  name                String
  active              Boolean               @default(true)
  scheduleCron        String?
  condition           Json
  action              Json
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  userId              String?
  followup_deliveries followup_deliveries[]
  followup_mappings   followup_mappings     @relation(fields: [mappingId], references: [id], onDelete: Cascade)
  users               users?                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([mappingId])
  @@index([userId])
}

model interactions {
  id                 Int       @id @default(autoincrement())
  lead_id            Int?
  interaction_type   String?   @db.VarChar(50)
  interaction_date   DateTime? @default(now()) @db.Timestamp(6)
  message            String?
  followup_required  Boolean?  @default(false)
  next_followup_date DateTime? @db.Date
  created_by         String?   @db.VarChar(100)
  leads              leads?    @relation(fields: [lead_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model kb_chunks {
  id           String       @id
  tenantId     String
  documentId   String
  content      String
  embedding    Float[]
  createdAt    DateTime     @default(now())
  kb_documents kb_documents @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([documentId])
  @@index([tenantId])
}

model kb_documents {
  id        String      @id
  tenantId  String
  filename  String
  mimeType  String
  size      Int
  createdAt DateTime    @default(now())
  kb_chunks kb_chunks[]

  @@index([createdAt])
  @@index([tenantId])
}

model knowledge_base {
  id         String     @id
  businessId String
  title      String
  content    String
  category   String?
  tags       String[]
  isActive   Boolean    @default(true)
  viewCount  Int        @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime
  deletedAt  DateTime?
  businesses businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([category])
  @@index([deletedAt])
  @@index([isActive])
}

model leads {
  id                 Int            @id @default(autoincrement())
  full_name          String         @db.VarChar(150)
  email              String?        @db.VarChar(150)
  phone_number       String?        @db.VarChar(30)
  source             String?        @db.VarChar(100)
  status             String?        @default("New") @db.VarChar(50)
  last_contacted     DateTime?      @db.Timestamp(6)
  next_followup_date DateTime?      @db.Date
  assigned_agent     String?        @db.VarChar(100)
  notes              String?
  created_at         DateTime?      @default(now()) @db.Timestamp(6)
  updated_at         DateTime?      @default(now()) @db.Timestamp(6)
  deals              deals[]
  interactions       interactions[]
  reminders          reminders[]
}

model locations {
  id              String            @id
  businessId      String
  name            String
  address         String
  city            String
  state           String
  zipCode         String
  country         String            @default("US")
  phone           String?
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  deletedAt       DateTime?
  businesses      businesses        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  operating_hours operating_hours[]

  @@index([businessId])
  @@index([deletedAt])
}

model mapping_validations {
  id                String            @id
  mappingId         String
  valid             Boolean
  details           Json
  validatedAt       DateTime          @default(now())
  followup_mappings followup_mappings @relation(fields: [mappingId], references: [id], onDelete: Cascade)

  @@index([mappingId])
  @@index([validatedAt])
}

model menu_items {
  id          String      @id
  businessId  String
  categoryId  String?
  name        String
  description String?
  price       Decimal     @db.Decimal(10, 2)
  image       String?
  isAvailable Boolean     @default(true)
  sortOrder   Int         @default(0)
  allergens   String[]
  calories    Int?
  prepTime    Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  businesses  businesses  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  categories  categories? @relation(fields: [categoryId], references: [id])

  @@index([businessId])
  @@index([categoryId])
  @@index([deletedAt])
  @@index([isAvailable])
}

model menus {
  id          String     @id
  businessId  String
  itemName    String
  description String?
  price       Decimal    @db.Decimal(10, 2)
  available   Boolean    @default(true)
  category    String?
  aiSuggested Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  businesses  businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([available])
  @@index([businessId])
  @@index([deletedAt])
}

model messages {
  id             String        @id
  conversationId String
  sender         String
  text           String
  createdAt      DateTime      @default(now())
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model operating_hours {
  id         String    @id
  locationId String
  dayOfWeek  Int
  openTime   String
  closeTime  String
  isClosed   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  locations  locations @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, dayOfWeek])
  @@index([locationId])
}

model order_items {
  id        String   @id
  orderId   String
  name      String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime
  orders    orders   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model order_taking_agents {
  id                           String                         @id
  businessId                   String
  name                         String
  description                  String
  isActive                     Boolean                        @default(false)
  launchedAt                   DateTime?
  createdAt                    DateTime                       @default(now())
  updatedAt                    DateTime
  businesses                   businesses                     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  order_taking_locations       order_taking_locations[]
  order_taking_menu_items      order_taking_menu_items[]
  order_taking_operating_hours order_taking_operating_hours[]
  order_taking_policies        order_taking_policies[]

  @@index([businessId])
  @@index([isActive])
}

model order_taking_locations {
  id                  String              @id
  agentId             String
  name                String
  address             String
  phone               String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  order_taking_agents order_taking_agents @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

model order_taking_menu_items {
  id                  String              @id
  agentId             String
  name                String
  description         String?
  price               Decimal             @db.Decimal(10, 2)
  isAvailable         Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  order_taking_agents order_taking_agents @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

model order_taking_operating_hours {
  id                  String              @id
  agentId             String
  dayOfWeek           Int
  openTime            String
  closeTime           String
  isClosed            Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  order_taking_agents order_taking_agents @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, dayOfWeek])
  @@index([agentId])
}

model order_taking_policies {
  id                  String              @id
  agentId             String
  title               String
  type                String
  content             String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  order_taking_agents order_taking_agents @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([type])
}

model orders {
  id              String        @id
  businessId      String
  customerName    String
  customerContact String
  status          OrderStatus   @default(PENDING)
  totalPrice      Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  deletedAt       DateTime?
  order_items     order_items[]
  businesses      businesses    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([deletedAt])
  @@index([status])
}

model overage_charges {
  id                     String     @id
  business_id            String
  quota_type             String
  overage_amount         Int
  rate_per_unit          Int
  total_charge_cents     Int
  billing_period_start   DateTime
  billing_period_end     DateTime
  stripe_invoice_item_id String?
  status                 String     @default("pending")
  created_at             DateTime   @default(now())
  businesses             businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([billing_period_start, billing_period_end])
  @@index([business_id])
  @@index([status])
}

model plan_changes {
  id                                                           String            @id
  business_id                                                  String
  from_plan_id                                                 String?
  to_plan_id                                                   String
  change_type                                                  String
  change_timing                                                String
  status                                                       String            @default("pending")
  proration_credit                                             Int               @default(0)
  proration_charge                                             Int               @default(0)
  net_charge                                                   Int               @default(0)
  effective_date                                               DateTime?
  reason                                                       String?
  approved_by                                                  String?
  created_at                                                   DateTime          @default(now())
  updated_at                                                   DateTime
  businesses                                                   businesses        @relation(fields: [business_id], references: [id], onDelete: Cascade)
  plan_definitions_plan_changes_from_plan_idToplan_definitions plan_definitions? @relation("plan_changes_from_plan_idToplan_definitions", fields: [from_plan_id], references: [id])
  plan_definitions_plan_changes_to_plan_idToplan_definitions   plan_definitions  @relation("plan_changes_to_plan_idToplan_definitions", fields: [to_plan_id], references: [id])

  @@index([business_id])
  @@index([effective_date])
  @@index([status])
}

model plan_definitions {
  id                                                       String          @id
  name                                                     String
  description                                              String?
  price_cents                                              Int
  currency                                                 String          @default("usd")
  billing_interval                                         String          @default("month")
  trial_days                                               Int             @default(0)
  stripe_price_id                                          String?
  is_active                                                Boolean         @default(true)
  display_order                                            Int             @default(0)
  created_at                                               DateTime        @default(now())
  updated_at                                               DateTime
  feature_flags                                            feature_flags[]
  plan_changes_plan_changes_from_plan_idToplan_definitions plan_changes[]  @relation("plan_changes_from_plan_idToplan_definitions")
  plan_changes_plan_changes_to_plan_idToplan_definitions   plan_changes[]  @relation("plan_changes_to_plan_idToplan_definitions")
  plan_features                                            plan_features[]
}

model plan_features {
  id               String           @id
  plan_id          String
  feature_key      String
  feature_type     String
  limit_value      Int?
  boolean_value    Boolean?
  enum_value       String?
  metadata         Json?
  created_at       DateTime         @default(now())
  plan_definitions plan_definitions @relation(fields: [plan_id], references: [id], onDelete: Cascade)

  @@unique([plan_id, feature_key])
}

model plan_recommendations {
  id                  String     @id
  business_id         String
  current_plan_id     String
  recommended_plan_id String
  confidence_score    Float
  savings_potential   Int?
  upgrade_cost        Int?
  reasoning           Json
  is_applied          Boolean    @default(false)
  created_at          DateTime   @default(now())
  businesses          businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([current_plan_id])
  @@index([recommended_plan_id])
}

model policies {
  id            String     @id
  businessId    String
  type          String
  title         String
  content       String
  isActive      Boolean    @default(true)
  effectiveDate DateTime   @default(now())
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  deletedAt     DateTime?
  businesses    businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([deletedAt])
  @@index([type])
}

model PoppyAnalysisSession {
  id        String   @id
  tenantId  String
  datasetId String?
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dataset   PoppyDataset? @relation(fields: [datasetId], references: [id], onDelete: SetNull)
  tenant    PoppyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  artifacts PoppyArtifact[]
  messages  PoppyChatMessage[]

  @@index([createdAt])
  @@index([datasetId])
  @@index([tenantId])
  @@map("poppy_analysis_sessions")
}

model PoppyArtifact {
  id          String   @id
  sessionId   String
  tenantId    String
  type        String
  title       String
  data        Json
  metadata    Json?
  createdAt   DateTime @default(now())
  session     PoppyAnalysisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tenant      PoppyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  explanation PoppyExplanation?
  tokenUsage  PoppyTokenUsage[]

  @@index([createdAt])
  @@index([sessionId])
  @@index([tenantId])
  @@map("poppy_artifacts")
}

model PoppyAuditLog {
  id          String   @id
  userId      String
  tenantId    String
  action      String
  resourceType String
  resourceId  String?
  metadata    Json?
  timestamp   DateTime @default(now())
  tenant      PoppyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        PoppyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resourceType])
  @@index([tenantId])
  @@index([timestamp])
  @@index([userId])
  @@map("poppy_audit_logs")
}

model PoppyAuthSession {
  id        String        @id
  userId    String
  tenantId  String
  role      PoppyUserRole
  expiresAt DateTime
  createdAt DateTime      @default(now())

  @@index([expiresAt])
  @@index([tenantId])
  @@index([userId])
  @@map("poppy_auth_sessions")
}

model PoppyChatMessage {
  id        String   @id
  sessionId String
  tenantId  String
  role      String
  content   String
  createdAt DateTime @default(now())
  session   PoppyAnalysisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([sessionId])
  @@index([tenantId])
  @@map("poppy_chat_messages")
}

model PoppyDataQualityCheck {
  id              String   @id
  datasetVersionId String  @unique
  rowCount        Int
  checksRunAt     DateTime @default(now())
  timeCoverage    Json?
  nullIssues      Json
  outlierSummary  Json?
  warnings        Json
  version         PoppyDatasetVersion @relation(fields: [datasetVersionId], references: [id], onDelete: Cascade)

  @@index([datasetVersionId])
  @@map("poppy_data_quality_checks")
}

model PoppyDatasetProfile {
  id              String   @id
  datasetVersionId String  @unique
  rowCount        Int
  columnCount     Int
  columns         Json
  createdAt       DateTime @default(now())
  version         PoppyDatasetVersion @relation(fields: [datasetVersionId], references: [id], onDelete: Cascade)

  @@index([datasetVersionId])
  @@map("poppy_dataset_profiles")
}

model PoppyDatasetVersion {
  id          String   @id
  datasetId   String
  tenantId    String
  version     Int
  filePath    String
  fileSize    Int
  rowCount    Int?
  columnCount Int?
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  qualityCheck PoppyDataQualityCheck?
  profile      PoppyDatasetProfile?
  dataset      PoppyDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([datasetId, version])
  @@index([datasetId])
  @@index([tenantId])
  @@index([uploadedAt])
  @@map("poppy_dataset_versions")
}

model PoppyDataset {
  id          String   @id
  tenantId    String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    PoppyAnalysisSession[]
  versions    PoppyDatasetVersion[]
  tenant      PoppyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([tenantId])
  @@map("poppy_datasets")
}

model PoppyExplanation {
  id           String   @id
  sessionId    String
  artifactId   String   @unique
  summary      String
  implications Json?
  caveats      Json?
  createdAt    DateTime @default(now())
  artifact     PoppyArtifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@index([artifactId])
  @@index([createdAt])
  @@index([sessionId])
  @@map("poppy_explanations")
}

model PoppyTenant {
  id          String   @id
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    PoppyAnalysisSession[]
  artifacts   PoppyArtifact[]
  auditLogs   PoppyAuditLog[]
  datasets    PoppyDataset[]
  tokenUsage  PoppyTokenUsage[]
  users       PoppyUser[]

  @@index([createdAt])
  @@map("poppy_tenants")
}

model PoppyTokenUsage {
  id               String   @id
  userId           String
  tenantId         String
  sessionId        String?
  artifactId       String?
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float
  timestamp        DateTime @default(now())
  artifact         PoppyArtifact? @relation(fields: [artifactId], references: [id], onDelete: SetNull)
  tenant           PoppyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             PoppyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([tenantId])
  @@index([timestamp])
  @@index([userId])
  @@map("poppy_token_usage")
}

model PoppyUser {
  id         String   @id
  email      String   @unique
  name       String?
  passwordHash String?
  tenantId   String
  role       PoppyUserRole @default(MEMBER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  auditLogs  PoppyAuditLog[]
  tokenUsage PoppyTokenUsage[]
  tenant     PoppyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([email])
  @@index([tenantId])
  @@map("poppy_users")
}

model powerups {
  id          String     @id
  businessId  String
  powerupName String
  enabled     Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  businesses  businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([deletedAt])
  @@index([enabled])
}

model query_logs {
  id           String         @id
  businessId   String
  query        String
  response     String?
  status       QueryLogStatus @default(SUCCESS)
  responseTime Int?
  userAgent    String?
  ipAddress    String?
  metadata     Json?
  createdAt    DateTime       @default(now())
  businesses   businesses     @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([createdAt])
  @@index([status])
}

model question_analytics {
  id                 String   @id
  conversationId     String
  tenantId           String
  questionText       String
  normalizedQuestion String
  detectedIntent     String?
  confidenceLevel    String
  coverageStatus     String
  supportIntent      String?
  sentiment          String?
  createdAt          DateTime @default(now())

  @@index([confidenceLevel])
  @@index([conversationId])
  @@index([coverageStatus])
  @@index([createdAt])
  @@index([normalizedQuestion])
  @@index([supportIntent])
  @@index([tenantId])
}

model reminders {
  id            Int       @id @default(autoincrement())
  lead_id       Int?
  reminder_text String?   @db.VarChar(255)
  reminder_date DateTime? @db.Timestamp(6)
  created_by    String?   @db.VarChar(100)
  is_completed  Boolean?  @default(false)
  leads         leads?    @relation(fields: [lead_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model subscriptions {
  id                 String             @id
  businessId         String
  planId             String
  status             SubscriptionStatus @default(TRIAL)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  trialStart         DateTime?
  trialEnd           DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  businesses         businesses         @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([currentPeriodEnd])
  @@index([status])
}

model tenant_database_configs {
  id        String       @id
  tenantId  String       @unique
  host      String
  port      Int
  username  String
  password  String
  database  String
  createdAt DateTime     @default(now())
  updatedAt DateTime
  dbType    DatabaseType @default(POSTGRESQL)

  @@index([tenantId])
}

model tenant_table_mappings {
  id               String   @id
  tenantId         String   @unique
  tableName        String?
  primaryKeyColumn String?
  displayFields    Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime

  @@index([tenantId])
}

model usage_alerts {
  id                   String     @id
  business_id          String
  alert_type           String
  quota_type           String
  threshold_percentage Int?
  triggered_at         DateTime   @default(now())
  acknowledged_at      DateTime?
  resolved_at          DateTime?
  notification_sent    Boolean    @default(false)
  businesses           businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([alert_type])
  @@index([business_id])
  @@index([triggered_at])
}

model usage_events {
  id              String     @id
  business_id     String
  event_type      String
  quantity        Int        @default(1)
  tokens_consumed Int?
  cost_cents      Int?
  metadata        Json?
  created_at      DateTime   @default(now())
  businesses      businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([created_at])
  @@index([event_type])
}

model usage_forecasts {
  id               String     @id
  business_id      String
  quota_type       String
  forecast_date    DateTime
  predicted_usage  Int
  confidence_score Float      @default(0.0)
  model_version    String     @default("v1.0")
  created_at       DateTime   @default(now())
  businesses       businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@index([business_id])
  @@index([forecast_date])
}

model usage_metrics {
  id         String     @id
  businessId String
  type       UsageType
  count      Int        @default(1)
  metadata   Json?
  date       DateTime   @default(now())
  createdAt  DateTime   @default(now())
  businesses businesses @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([date])
  @@index([type])
}

model usage_quotas {
  id                 String     @id
  business_id        String
  plan_id            String
  quota_type         String
  quota_limit        Int
  quota_used         Int        @default(0)
  quota_overage      Int        @default(0)
  reset_date         DateTime
  last_reset_date    DateTime?
  overage_rate_cents Int        @default(0)
  created_at         DateTime   @default(now())
  updated_at         DateTime
  businesses         businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, quota_type])
}

model usage_rollups {
  id                String     @id
  business_id       String
  quota_type        String
  usage_date        DateTime
  total_usage       Int
  unique_users      Int        @default(0)
  peak_hourly_usage Int        @default(0)
  cost_cents        Int        @default(0)
  created_at        DateTime   @default(now())
  businesses        businesses @relation(fields: [business_id], references: [id], onDelete: Cascade)

  @@unique([business_id, quota_type, usage_date])
}

model users {
  id                String              @id
  businessId        String
  email             String
  passwordHash      String
  firstName         String
  lastName          String
  role              UserRole            @default(STAFF)
  isActive          Boolean             @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  deletedAt         DateTime?
  followup_mappings followup_mappings[]
  followup_rules    followup_rules[]
  businesses        businesses          @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, email])
  @@index([deletedAt])
  @@index([email])
  @@index([role])
}

enum ApiKeyStatus {
  ACTIVE
  INACTIVE
  REVOKED
}

enum BusinessStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

enum ConnectionStatus {
  ACTIVE
  INACTIVE
  UNREACHABLE
  ERROR
}

enum DatabaseType {
  POSTGRESQL
  MYSQL
  MONGODB
  FIREBASE
}

enum EmbeddingType {
  MENU
  POLICY
  FAQ
  BUSINESS
}

enum OrderStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PoppyUserRole {
  OWNER
  MEMBER
  VIEWER
}

enum QueryLogStatus {
  SUCCESS
  ERROR
  TIMEOUT
  RATE_LIMITED
}

enum ReplyStatus {
  NoReply
  Replied
  Bounced
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum UsageType {
  QUERY
  ORDER
  INTEGRATION
  API_CALL
  STORAGE
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
  VIEWER
}
